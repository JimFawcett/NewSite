<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>x-two-panel — Test</title>
  <link rel="stylesheet" href="../../css/reset.css">
  <link rel="stylesheet" href="../../css/Content.css">
  <!-- placed at bottom of page -->
  <!-- <script src="js/TwoPanelComponentUsingButtons.js" defer></script> -->

  <!-- Link to google fonts -->
  <!-- Noto Sans: 400 & 500 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500&display=swap" rel="stylesheet">
  <!-- Comic Neue: 400 & 700 -->
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <!-- JetBrains Mono: 400 & 700 -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <!-- monospace code font -->

  <style>
    * { box-sizing: border-box; }

    :root {
      /* global variable shared between DOM and Shadow DOM */
      --app-panel-height: 70vh;
    }

    body { 
      margin: 0; 
      font: 18px/1.3 "Noto Sans", Arial, sans-serif; 
      padding: 1rem; 
      background:#f6f7fb; 
      color:#1f2328; 
    }
    .demo { 
      border:1px solid #aaa; 
      border-radius:10px; 
      background:#fff; 
      padding:0rem 1rem 1rem; 
    }
    div.toolbar {
      margin: 0.5rem 0rem;
    }
    div.toolbar button {
      padding:0.15rem 0.75rem;
    }

    /* style component */
    x-two-panel {
      --two-height: var(--app-panel-height);
      --two-panel-pad: 0rem;
    }

    /* style component panels */
    x-two-panel::part(left-panel),
    x-two-panel::part(right-panel) {
      border: 2px solid black; padding:0.5rem 0.5rem;
      font-family: "Comic Neue", Arial, sans-serif;
    }

    x-two-panel[collapsed-left]::part(right-panel) { 
      display: flex; flex-direction: column; min-height: 0; 
    }
    x-two-panel[collapsed-left]::part(right-scroller) { 
      height: auto; flex: 1 1 auto; min-height: 0; overflow: auto; 
    }

    .left-slot {
      height: calc(var(--app-panel-height) - 2rem);
      display:flex;
      flex-direction: column;
      min-height: 0rem;
    }

    /* Firefox-only (safe on Win11 too); avoid disturbing Blink/WebKit */
    @-moz-document url-prefix() {
      x-two-panel:not([collapsed-left])::part(left-panel),
      x-two-panel:not([collapsed-left])::part(right-panel) {
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      /* Let the scrollers fill by flex growth, not % height */
      x-two-panel::part(left-scroller),
      x-two-panel::part(right-scroller) {
        height: auto !important;   /* stop relying on 100% */
        flex: 1 1 auto;            /* fill remaining panel height */
        min-height: 0;             /* allow content to shrink */
        overflow: auto;            /* keep your scroll behavior */
      }
    }

    /* Per-instance overrides */
    #panel.slim {
      --two-gap: .25rem;
      --two-step: 1.5rem;
      --two-min-right: 6rem;
    }

    pre.code-demo {
      margin: 0 0 1rem;
      padding: 0rem;
      background: transparent;
      overflow-x: auto;
      border-radius: 8ps;
    }

    pre.code-demo > code {
      display:block;
      padding:1rem;
      background-color: #333;
      color: #eee;
      border-radius: 8px;
      font-size: 0.85rem/1.35;
      font-family: 'JetBrains Mono' ui-monospace, SFMono-Regular, Meno, Consolas, monospace;
      white-space: inherit;
      text-indent: 0 !important;          /* beats global “hanging” styles */
      transform: none !important;         /* kills translateX tricks */
      padding-inline-start: 0.25rem;      /* force logical-left padding */
      background-clip: padding-box;       /* background covers padding */
    }

    /* visible dark box lives on the CHILD, not the slotted element */
    .code-box {
      display: block;
      padding: 0.75rem;        /* ← inner gutter you want */
      background: #333;
      color: #eee;
      border-radius: 8px;
      overflow-x: auto;        /* scroll the whole code box */
    }

    /* keep <pre> neutral so the child controls the visuals */
    .code-box > pre.code-demo {
      margin: 0;
      padding: 0;              /* avoid double padding */
      background: transparent; /* dark bg is on .code-box */
      font: 0.85rem/1.35 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      white-space: pre;
    }
    .code-box > pre.code-demo > code { white-space: inherit; }
    
  </style>
</head>
<body id="github">
  <h1>Two-Panel Component Test</h1>
  <div class="demo">
    <tm-b><a href="../../PageHost.html?src=WebDev/ExploreWebDev.html">Home</a></tm-b>
    <!-- Toolbar targets the panel by id -->
    <div class="toolbar">
      <button data-two="narrow"     data-two-for="#panel" data-step="6rem">Narrow</button>
      <button data-two="reset"      data-two-for="#panel">Reset</button>
      <button data-two="widen"      data-two-for="#panel" data-step="6rem">Widen</button>
      <button data-two="toggle-left"data-two-for="#panel">Toggle Left</button>
    </div>
    <!-- data-left-fixed holds left width constant when container resizes -->
    <x-two-panel id="panel" left="25rem" data-left-fixed>  <!-- can use gap= here -->
      <div slot="left" class="left-slot">
        <p>Buttons are handled by the component; no client JS required.</p>
        <div class="notes" style="margin-bottom: 0.75rem;">
          <t-b>
            x-two-panel component defines default styles that can be 
            overridden by panel attributes or CSS styling.
          </t-b>
          <t-b style="margin-bottom:0rem;">
            The complete public interface is defined in the README.md file 
            linked below.
          </t-b>
        </div>
        <t-b>
          <a target="_blank" href="./x-two-panel-README.md.txt">README.md</a>
        </t-b>
        <t-b>
          For examples this panel holds descriptions of the code shown in 
          the right panel.
        </t-b>
      </div>
      <div slot="right" class="right-slots">
        <div class="code-box">
          <h3>TwoPanelComponentUsingButtons</h3>
          <p>Source code for Component</p>
          <pre class="code-demo"><code>/* x-two-panel.external.scroller.cssvars.js - classic &lt;script&gt;, no modules
    - External controls only (buttons with [data-two] + data-two-for=&quot;#id&quot;).
    - Slotted content lives in inner &quot;.scroller&quot; (avoids rounded-corner clipping).
    - Fallback defaults moved into the component:
        --two-gap: 0.50rem
        --two-panel-pad: 0.5rem 0rem
        --two-step: 6rem   (unless left is %, then default is 5%)
        --two-min-left: 8rem
        --two-min-right: 8rem
      (Apps can override these by setting the same CSS vars on x-two-panel.)
    - Equal columns when fixed-left and no --two-left provided:
        var(--two-left, calc(50% - var(--two-gap, 0.50rem)/2))
    - NOT porting --two-height; default remains max-content.
*/

(function () {
  var CSS_TEXT = '&#92;
:host{display:block}&#92;
.wrap{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);column-gap:var(--two-gap,0.50rem);height:var(--two-height,max-content);width:100%;box-sizing:border-box;overflow:visible;background:var(--two-bg,transparent);border:var(--two-border,none);border-radius:0;padding:var(--two-pad,0)}&#92;
:host([data-left-fixed]) .wrap{grid-template-columns:minmax(0,var(--two-left,calc(50% - var(--two-gap,0.50rem)/2))) minmax(0,1fr)}&#92;
.panel{min-width:0;min-height:0;overflow:visible;box-sizing:border-box;background:var(--two-panel-bg,#fff);border:var(--two-panel-border,1px solid #ececf2);border-radius:10px}&#92;
.scroller{min-width:0;min-height:0;height:100%;overflow-y:auto;overflow-x:var(--two-scroller-overflow-x,hidden);padding:var(--two-panel-pad,0.5rem 0rem);box-sizing:border-box}&#92;
:host([collapsed-left]) .wrap{grid-template-columns:1fr}&#92;
:host([collapsed-left]) .left{display:none}&#92;
::slotted(.left-panel),::slotted(.right-panel){border:none;padding:0}&#92;
::slotted(.left-slot),::slotted(.right-slot){border:none}';

  // ---------- helpers ----------
  function attachStyles(shadowRoot, cssText) {
    var style = document.createElement('style');
    style.textContent = cssText;
    shadowRoot.appendChild(style);
  }
  function parseLen(s) {
    var m = String(s || '').trim().match(/^(-?&#92;d*&#92;.?&#92;d+)&#92;s*(px|rem|%)$/i);
    if (!m) return { n: parseFloat(s) || 0, unit: 'px' };
    return { n: parseFloat(m[1]), unit: m[2].toLowerCase() };
  }
  function rootFontSize(el) {
    var root = (el.getRootNode && el.getRootNode()) || document;
    var doc = root instanceof Document ? root : document;
    var fs = parseFloat(getComputedStyle(doc.documentElement).fontSize);
    return isFinite(fs) && fs &gt; 0 ? fs : 16;
  }
  function readVarPx(host, name) {
    var raw = getComputedStyle(host).getPropertyValue(name).trim();
    if (!raw) return null;                      // variable not set
    var p = parseLen(raw);
    return convert(p.n, p.unit, 'px', host);
  }
  function gapPx(el) {
    // read using the same fallback as CSS: var(--two-gap, 0.50rem)
    var raw = getComputedStyle(el).getPropertyValue('--two-gap').trim() || '0.50rem';
    var p = parseLen(raw);
    return convert(p.n, p.unit, 'px', el);
  }
  function availablePx(el) {
    var hostW = el.getBoundingClientRect().width || 1;
    return Math.max(0, hostW - gapPx(el));
  }
  function convert(value, fromUnit, toUnit, el) {
    if (fromUnit === toUnit) return value;
    var rfs = rootFontSize(el);
    // rem &lt;-&gt; px
    if (fromUnit === 'rem' && toUnit === 'px') return value * rfs;
    if (fromUnit === 'px'  && toUnit === 'rem') return value / rfs;

    // % &lt;-&gt; px relative to *available* width (host - gap)
    var avail = availablePx(el) || 1;
    if (fromUnit === '%' && toUnit === 'px') return (value / 100) * avail;
    if (fromUnit === 'px' && toUnit === '%')  return (value / avail) * 100;

    // % &lt;-&gt; rem via px
    if (fromUnit === '%' && toUnit === 'rem') return ((value / 100) * avail) / rfs;
    if (fromUnit === 'rem' && toUnit === '%') return (value * rfs / avail) * 100;

    return value;
  }
  function readAttrPx(host, attrName) {
    if (!host.hasAttribute(attrName)) return null;
    var v = host.getAttribute(attrName).trim().toLowerCase();
    if (attrName === 'max-left' && v === 'auto') {
      // &quot;auto&quot; =&gt; container - gap - min-right (attr/CSS var/default)
      var minRightPx = readVarPx(host, '--two-min-right');
      if (minRightPx == null) {
        var a = host.getAttribute('min-right');
        minRightPx = a ? convert(parseLen(a).n, parseLen(a).unit, 'px', host) : convert(8, 'rem', 'px', host);
      }
      return Math.max(0, availablePx(host) - minRightPx);
    }
    var p = parseLen(v);
    return convert(p.n, p.unit, 'px', host);
  }
  function closestControl(target) { return target.closest ? target.closest('[data-two]') : null; }
  function resolveHost(sel) {
    if (!sel) return null;
    if (sel.charAt(0) === '#') return document.getElementById(sel.slice(1));
    try { return document.querySelector(sel); } catch (_) { return null; }
  }

  // ---------- custom element ----------
  function XTwoPanel() {
    var self = Reflect.construct(HTMLElement, [], new.target);
    self._root = self.attachShadow({ mode: 'open' });

    attachStyles(self._root, CSS_TEXT);
    var wrap = document.createElement('div');
    wrap.className = 'wrap';
    wrap.setAttribute('part', 'wrap');
    wrap.setAttribute('role', 'group');
    wrap.setAttribute('aria-label', 'Two panel');
    wrap.innerHTML =
      '&lt;section class=&quot;panel left&quot;  part=&quot;left-panel&quot;&gt;'+
        '&lt;div class=&quot;scroller&quot; part=&quot;left-scroller&quot;&gt;&lt;slot name=&quot;left&quot;&gt;&lt;/slot&gt;&lt;/div&gt;'+
      '&lt;/section&gt;'+
      '&lt;section class=&quot;panel right&quot; part=&quot;right-panel&quot;&gt;'+
        '&lt;div class=&quot;scroller&quot; part=&quot;right-scroller&quot;&gt;&lt;slot name=&quot;right&quot;&gt;&lt;/slot&gt;&lt;/div&gt;'+
      '&lt;/section&gt;';
    self._root.appendChild(wrap);

    self._wrap = wrap;
    self._leftPanel  = wrap.querySelector('.left');

    // capture initial attributes for reset()
    self._initCaptured = false;
    self._init = { left: null, gap: null };

    return self;
  }
  XTwoPanel.prototype = Object.create(HTMLElement.prototype);
  XTwoPanel.prototype.constructor = XTwoPanel;

  Object.defineProperty(XTwoPanel, 'observedAttributes', {
    get: function () { return ['left', 'gap', 'height', 'step', 'min-left', 'max-left', 'min-right']; }
  });

  XTwoPanel.prototype.connectedCallback = function () {
    if (!this._initCaptured) {
      this._init.left = this.hasAttribute('left') ? this.getAttribute('left') : null;
      this._init.gap  = this.hasAttribute('gap')  ? this.getAttribute('gap')  : null;
      this._initCaptured = true;
    }
    this._applyAll();
  };
  XTwoPanel.prototype.attributeChangedCallback = function () { this._applyAll(); };

  XTwoPanel.prototype._applyAll = function () {
    // height (no new default; still max-content unless page sets --two-height or height attr)
    var height = (this.getAttribute('height') || '').trim();
    if (height) this.style.setProperty('--two-height', height);
    else this.style.removeProperty('--two-height');

    // gap (attribute maps to CSS var; CSS var from page can override if attribute omitted)
    var gap = (this.getAttribute('gap') || '').trim();
    if (gap) this.style.setProperty('--two-gap', gap);
    else this.style.removeProperty('--two-gap');

    // left (preserve user-provided data-left-fixed flag)
    var left = (this.getAttribute('left') || '').trim();
    if (left) {
      this.style.setProperty('--two-left', left);
      if (!this.hasAttribute('data-left-fixed')) {
        this.setAttribute('data-left-fixed', '');
        this._managedLeftFlag = true; // we added it
      }
    } else {
      this.style.removeProperty('--two-left');
      if (this._managedLeftFlag) {
        this.removeAttribute('data-left-fixed');
        this._managedLeftFlag = false;
      }
    }
  };

  // ----- public API for external controls -----
  XTwoPanel.prototype.setLeft = function (value) {
    this.removeAttribute('collapsed-left');
    this.setAttribute('left', value);
  };
  XTwoPanel.prototype.setGap = function (value) {
    this.setAttribute('gap', value);
  };
  XTwoPanel.prototype.toggleLeft = function () {
    if (this.hasAttribute('collapsed-left')) this.removeAttribute('collapsed-left');
    else this.setAttribute('collapsed-left', '');
  };
  XTwoPanel.prototype.reset = function () {
    this.removeAttribute('collapsed-left');
    if (this._init.left !== null) this.setAttribute('left', this._init.left);
    else this.removeAttribute('left');
    if (this._init.gap !== null) this.setAttribute('gap', this._init.gap);
    else this.removeAttribute('gap');
  };

  // Symmetric stepping with CSS-var/attr-configurable bounds
  XTwoPanel.prototype.step = function (sign, stepOverride) {
    var cur = this.getAttribute('left');
    if (!cur) {
      var pxNow = this._leftPanel.getBoundingClientRect().width;
      var rem = (pxNow / rootFontSize(this)).toFixed(3) + 'rem';
      this.setAttribute('left', rem);
      cur = rem;
    }

    var parsed = parseLen(cur);
    var unit   = parsed.unit;
    var leftPx = convert(parsed.n, unit, 'px', this);

    // STEP (button &gt; CSS var &gt; attr &gt; default)
    var deltaPx;
    if (stepOverride) {
      var so = parseLen(stepOverride);
      deltaPx = convert(so.n, so.unit, 'px', this);
    } else {
      var cssStepPx = readVarPx(this, '--two-step'); // e.g., 6rem as px
      if (cssStepPx != null) {
        deltaPx = cssStepPx;
      } else if (this.hasAttribute('step')) {
        var sp = parseLen(this.getAttribute('step'));
        deltaPx = convert(sp.n, sp.unit, 'px', this);
      } else {
        // default: keep 5% when in %, else 6rem per your requested default
        var def = (unit === '%') ? parseLen('5%') : parseLen('6rem');
        deltaPx = convert(def.n, def.unit, 'px', this);
      }
    }

    // BOUNDS (CSS var &gt; attr &gt; default)
    var defMinLeftPx  = convert(8, 'rem', 'px', this);
    var defMinRightPx = convert(8, 'rem', 'px', this);

    var cssMinLeftPx  = readVarPx(this, '--two-min-left');
    var cssMinRightPx = readVarPx(this, '--two-min-right');
    var cssMaxLeftPx  = readVarPx(this, '--two-max-left');

    var minLeftPx  = (cssMinLeftPx  != null) ? cssMinLeftPx  : (readAttrPx(this, 'min-left')  ?? defMinLeftPx);
    var minRightPx = (cssMinRightPx != null) ? cssMinRightPx : (readAttrPx(this, 'min-right') ?? defMinRightPx);

    var containerMinusGap = availablePx(this);
    var autoMaxLeftPx     = Math.max(0, containerMinusGap - minRightPx);

    var userMaxPx = (cssMaxLeftPx != null) ? cssMaxLeftPx : (readAttrPx(this, 'max-left') ?? autoMaxLeftPx);
    var maxLeftPx = Math.min(autoMaxLeftPx, userMaxPx);
    if (maxLeftPx &lt; minLeftPx) maxLeftPx = minLeftPx;

    // apply step & clamp
    var nextLeftPx = leftPx + sign * deltaPx;
    nextLeftPx = Math.max(minLeftPx, Math.min(maxLeftPx, nextLeftPx));

    // back to current unit (preserve unit)
    var nextVal = convert(nextLeftPx, 'px', unit, this);
    var out;
    if (unit === '%') out = nextVal.toFixed(3) + '%';
    else if (unit === 'rem') out = nextVal.toFixed(3) + 'rem';
    else out = Math.round(nextVal) + 'px';

    this.setAttribute('left', out);
    this.removeAttribute('collapsed-left');
  };

  if (!customElements.get('x-two-panel')) {
    customElements.define('x-two-panel', XTwoPanel);
  }

  // ---------- global external-controls handler ----------
  if (!window.__X_TWO_PANEL_EXTERNAL_WIRED__) {
    document.addEventListener('click', function (ev) {
      var ctrl = closestControl(ev.target);
      if (!ctrl) return;

      var sel = ctrl.getAttribute('data-two-for') || ctrl.getAttribute('aria-controls');
      var host = resolveHost(sel);
      if (!host || host.tagName.toLowerCase() !== 'x-two-panel') return;

      var action = (ctrl.dataset.two || '').toLowerCase();
      switch (action) {
        case 'narrow':        host.step(-1, ctrl.dataset.step); break;
        case 'widen':         host.step(+1, ctrl.dataset.step); break;
        case 'toggle-left':   host.toggleLeft(); break;
        case 'reset':         host.reset(); break;
        case 'set-left':
          if (ctrl.dataset.left || ctrl.dataset.value) host.setLeft(ctrl.dataset.left || ctrl.dataset.value);
          break;
        case 'set-gap':
          if (ctrl.dataset.gap) host.setGap(ctrl.dataset.gap);
          break;
        case 'collapse-left': host.setAttribute('collapsed-left',''); break;
        case 'expand-left':   host.removeAttribute('collapsed-left'); break;
      }
    }, true);
    window.__X_TWO_PANEL_EXTERNAL_WIRED__ = true;
  }
})();        </code></pre>
        </div>
      </div>
    </x-two-panel>
  </div>
  <script src="js/TwoPanelComponentUsingButtons.js"></script>

  <!-- Linux Firefox height shim: place AFTER your other scripts -->
  <script>
  (function () {
    var ua = navigator.userAgent || "";
    var isFirefox = /Firefox\/\d+/.test(ua);
    var isLinux   = /Linux/.test(ua);
    if (!isFirefox || !isLinux) return;

    function applyHeights(root) {
      root.querySelectorAll('.left-slot details').forEach(function (d) {
        var summary = d.querySelector('summary');
        var fill    = d.querySelector('.fill');
        if (!summary || !fill) return;

        var styles = getComputedStyle(d);
        var pt = parseFloat(styles.paddingTop)    || 0;
        var pb = parseFloat(styles.paddingBottom) || 0;

        var avail = d.clientHeight - summary.offsetHeight - pt - pb;
        if (avail > 0) fill.style.height = avail + 'px';
      });
    }

    function wire(root) {
      var ro = new ResizeObserver(function(){ applyHeights(root); });
      root.querySelectorAll('.left-slot details, x-two-panel').forEach(function(el){
        try { ro.observe(el); } catch(e) {}
      });
      root.querySelectorAll('.left-slot details').forEach(function(d){
        d.addEventListener('toggle', function(){ applyHeights(root); });
      });
      window.addEventListener('resize', function(){ applyHeights(root); });
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(function(){ applyHeights(root); });
      }
      applyHeights(root);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function(){ wire(document); });
    } else {
      wire(document);
    }
  })();
  </script>
</body>
</html>
